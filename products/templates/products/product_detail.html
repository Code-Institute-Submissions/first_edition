{% extends "base.html" %}
{% load static %}

{% block page_header %}
<div class="container header-container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>

{% endblock %}

{% block content %}
    <div class="container-fluid mb-5">
        <div class="row">
            <div class="col-12 col-md-6 col-lg-2 offset-lg-3 grey pt-5">
                
                    {% if product.image %}
                        <a href="{{ product.image.url }}" target="_blank" class=" ">
                            <img class=" img-fluid image-product-detail ml-2" src="{{ product.image.url }}" alt="{{ product.name }}">
                        </a>
                        {% else %}
                        <a href="">
                            <img class=" img-fluid" src="{{ MEDIA_URL }}noimage.png" alt="{{ product.name }}">
                        </a>
                    {% endif %}
                <div class="row">
                    <div class="col-12">
                        <p>
                            
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4 grey pt-5">
                <div class="">
                    <h4 class="product-detail-txt">{{ product.name }}</h4>
                    <p class="">by {{ product.author }}</p>

                    <div class="">
                        <p>Format</p>
                    <a class=" btn button-style white-text">{{ product.book_format }} <br>
                                     ${{ product.price }}</a>
                    </div>

                    <form class="form" action="{% url 'add_to_bag' product.id %}" method="POST">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="col-12">
                                <p class="mt-3">Quantity:</p>
                                <div class="form-group w-25">
                                    <div class="input-group">
                                        <input class="form-control qty_input" type="number" name="quantity" value="1" min="1" max="5" data-item_id="{{ product.id }}" id="id_qty_{{ product.id }}">
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 pl-0">
                                <a href="{% url 'products' %}" class="btn rounded-0 pl-0">
                                    <span class="icon">
                                        <i class="fas fa-chevron-left coral-text"></i>
                                    </span>
                                    <span class="text-uppercase button-style">Keep Shopping</span>
                                </a>
                                <input type="submit" class="btn button-style rounded-0 text-uppercase" value="Add to Bag">
                            </div>
                            <input type="hidden" name="redirect_url" value="{{ request.path }}">
                        </div>
                    </form>

                    <form class="form" action="{% url 'add_to_save_for_later' product.id %}" method="POST">
                        {% csrf_token %}
                        <div class="form-row">
            
                            <div class="col-12 pl-0">
                               
                                <input type="submit" class="btn button-style rounded-0 text-uppercase" value="save for later">
                            </div>
                            <input type="hidden" name="redirect_url" value="{{ request.path }}">
                        </div>
                    </form>
                                            
                    {% if request.user.is_superuser %}
                                                <small class="ml-3">
                                                    <a href="{% url 'edit_product' product.id %}">Edit</a> | 
                                                    <a class="text-danger" href="{% url 'delete_product' product.id %}">Delete</a>
                                                </small>
                                            {% endif %}
                    <h4 class="product-detail-txt mt-4">Description</h4>
                    <p class="mt-3 ">{{ product.description }}</p>


                     <p class="">
                                                    <a class="text-muted" href="{% url 'products' %}?category={{ product.category.name }}">
                                                        <i class="fas fa-tag"></i>{{ product.category.friendly_name }}
                                                    </a>
                                                </p>
                    {% if product.rating %}
                        <small class="text-muted"><i class="fas fa-star mr-1"></i>{{ product.rating }} / 5</small>
                    {% else %}
                        <small class="text-muted">No Rating</small>
                    {% endif %}

                    {% if product.professional_endorsement  %}
                    <div class="pt-3">
                        <h4 class="product-detail-txt">Endorements</h4>
                        <p class="mt-3 ">"{{ product.professional_endorsement }}"</p>   
                        </div>                     
                    {% endif %}
                        <div class="pb-50">
                    <h4 class="product-detail-txt mt-4">Product Details</h4>
                    <p class="">ISBN: {{ product.isbn }}</p>
                    <p class="">Length: {{ product.num_pages }} pages</p>
                    <p class="">Publisher: {{ product.publisher }}</p>
                   

                                        <div class="pt-3">
                        <h4 class="product-detail-txt">Customer Reviews</h4>
                         {% for comment in review %}
                    <h5>{{ comment.create_at }}</h5>
                    {{ comment.subject }}
                    <p>{{ comment.review_text }}</p>
                    {{ comment.user }}
                    {% if user.session == comment.user %}
                    <a href="{% url 'edit_comment' product.id %}">Edit</a>
                    <a href="{% url 'delete_comment' product.id %}">Delete</a>
                    {% endif %}
                    {% endfor %}
                                             
                     <h6 class="">Write a review</h6>
                    <form class="" action="{% url 'add_comment' product.id %}" method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                        <input type="text " name="subject" placeholder="title">
						<textarea class="input w-75" name="review_text" placeholder="Your review"></textarea>
                        </div>
                        <button class="primary-btn" type="submit">Submit</button>
                    </form> 
                    </div>               
                    </div>
                    <div class="row">
                        <h6>rating</h6>
                        {{ rating }}
                             <form class="rate-form" action="" method="POST" id="{{rating.id}}">
                                 {% csrf_token %}
                            <button type="submit" class="fa fa-star  star-style" id="first"></button>
                            <button type="submit" class="fa fa-star  star-style" id="second"></button>
                            <button type="submit" class="fa fa-star  star-style" id="third"></button>
                            <button type="submit" class="fa fa-star  star-style" id="fourth"></button>
                            <button type="submit" class="fa fa-star  star-style" id="fifth"></button>
                            </form>
                            <div id="confirm-box"></div>
                    </div>
                </div>
            </div>
    
        </div>
        
    </div>

    
{% endblock %}

{% block postloadjs %}
    {{ block.super }}

    <script type="text/javascript">
const one = document.getElementById('first')
const two = document.getElementById('second')
const three = document.getElementById('third')
const four = document.getElementById('fourth')
const five = document.getElementById('fifth')


// get the form, confirm-box and csrf token
const form = document.querySelector('.rate-form')
const confirmBox = document.getElementById('confirm-box')
const csrf = document.getElementsByName('csrfmiddlewaretoken')



const handleStarSelect = (size) => {
    const children = form.children
    for (let i=0; i < children.length; i++) {
        if(i <= size) {
            children[i].classList.add('checked')
        } else {
            children[i].classList.remove('checked')
        }
    }
}

const handleSelect = (selection) => {
    switch(selection){
        case 'first': {
            // one.classList.add('checked')
            // two.classList.remove('checked')
            // three.classList.remove('checked')
            // four.classList.remove('checked')
            // five.classList.remove('checked')
            handleStarSelect(1)
            return
        }
        case 'second': {
            handleStarSelect(2)
            return
        }
        case 'third': {
            handleStarSelect(3)
            return
        }
        case 'fourth': {
            handleStarSelect(4)
            return
        }
        case 'fifth': {
            handleStarSelect(5)
            return
        }
        default: {
            handleStarSelect(0)
        }
    }

}

const getNumericValue = (stringValue) =>{
    let numericValue;
    if (stringValue === 'first') {
        numericValue = 1
    } 
    else if (stringValue === 'second') {
        numericValue = 2
    }
    else if (stringValue === 'third') {
        numericValue = 3
    }
    else if (stringValue === 'fourth') {
        numericValue = 4
    }
    else if (stringValue === 'fifth') {
        numericValue = 5
    }
    else {
        numericValue = 0
    }
    return numericValue
}

if (one) {
    const arr = [one, two, three, four, five]

    arr.forEach(item=> item.addEventListener('mouseover', (event)=>{
        handleSelect(event.target.id)
    }))

    arr.forEach(item=> item.addEventListener('click', (event)=>{
        // value of the rating not numeric
        const val = event.target.id
    
        
        let isSubmit = false
        form.addEventListener('submit', e=>{
            e.preventDefault()
    
            if (isSubmit) {
                return
            }
            isSubmit = true
            // picture id
            const id = e.target.id
            // value of the rating translated into numeric
            const val_num = getNumericValue(val)

            $.ajax({
                type: 'POST',
                url: '/add_rating/<int:product_id>/',
                data: {
                    'csrfmiddlewaretoken': csrf[0].value,
                    'el_id': id,
                    'val': val_num,
                },
                success: function(response){
                    console.log(response)
                    confirmBox.innerHTML = `<h1>Successfully rated with ${response.score}</h1>`
                },
                error: function(error){
                    console.log(error)
                    confirmBox.innerHTML = '<h1>Ups... something went wrong</h1>'
                }
            })
        })
    }))
}
    </script>
{% endblock %}